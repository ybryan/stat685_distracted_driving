---
title: "STAT 685: Distracted Driving"
subtitle: "Assignment 3"
author: "Bryan Yu: bryanyu@tamu.edu"
output: 
    slidy_presentation:
        highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
source(here::here('src', 'codebase', 'stan_utility.R'))
```

```{r data, message=FALSE}
library(ggplot2)
library(magrittr)
library(dplyr)

df <- feather::read_feather(here::here("study_df", "df_select.feather"))
subject_df <- feather::read_feather(here::here("study_df", "subject_df.feather"))

nd_nolanechange <- df %>% dplyr::filter(Drive == "ND") %>% 
    dplyr::filter(!dplyr::between(Distance, 5000, 7000))
md_nolanechange <- df %>% dplyr::filter(Drive == "MD")  %>%
    dplyr::filter(!dplyr::between(Distance, 5000, 7000))
```

## Objective

- Determine how lane deviation volatility is affected by sensorimotor driving (MD), aka texting while driving, compared to normal driving (ND)
    - Phases proceeding stimulus

- Eye gazing / pupilation are explanatory variables to lane positioning / volatility

- Compare lane deviation volatility by cohorts (age, gender, psychometric survey)

```{r, warning=FALSE, fig.align="center"}
ggplot(df, aes(x=Distance, y=Lane.Position)) +
    geom_line(aes(colour=phase)) +
    facet_grid(Drive ~ .) +
    theme_bw() +
    labs(x = 'Distance', y = 'Lane Position (m)') +
    theme(legend.position = "bottom")
```

## Model 1.0: First down

Trying to capture normal driving behavior without lane change and with age cohort

```{r, fig.width=4, fig.height=4, fig.align="center"}
ggplot(nd_nolanechange, aes(x=Distance, y=Lane.Position)) + 
    geom_line(aes(color=Subject)) +
    facet_grid(. ~ age_group)  +
    theme_bw() +
    labs(x = 'Distance', y = 'Lane Position (m)') +
    theme(legend.position = "none", axis.text.x = element_text(angle=70, hjust=1))
```


$$y_n \sim \mathcal{N}(\alpha + \mu_{i} + \beta x_{n}, \sigma)$$

Data: $y_n$: Log std deviation of lane position for each individual

$$p(\alpha) \sim \mathcal{N}(1.825, 0.25)$$
$$p(\mu_i) \sim \mathcal{N}(, )$$

## Sampling methodology

1. Hamiltonian Monte Carlo (HMC)

2. No U-Turn Sampling (NUTS)

## Facial expression data

- Multi-dimensional response to different stimuli (congitive, emotion, sensorimotor)

- Zero inflated data difficult to distinguish uniqueness between normal driving and texting

- Not immediately obvious that facial expression variables can be used for causal inference of lane volatility 

```{r facial_chart, message=FALSE, warning=FALSE, fig.align="center"}
nd_facs_df <- feather::read_feather(here::here("study_df", "facs_nd.feather"))
md_facs_df <- feather::read_feather(here::here("study_df", "facs_md.feather"))

all_facs <- list(nd_facs_df, md_facs_df) %>%
    set_names(c("ND", "MD")) %>%
    dplyr::bind_rows(.id = "DriveType")

tall_df <- all_facs %>% 
    dplyr::filter(Time %% 1 == 0) %>%
    tidyr::gather(emotion, value, -subject, -Frame, -Time, -DriveType)
    
ggplot(tall_df, aes(x=value, colour=DriveType, fill=DriveType)) +
    geom_histogram(alpha=0.5) +
    facet_grid(DriveType ~ emotion) +
    theme_bw() +
    labs(x = 'Facial Expression', y = '') +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle=90, hjust=1))
rm(nd_facs_df, md_facs_df, all_facs, tall_df)
```

* Downsampled from per frame sampling to per second sampling
