---
title: "Distracted Driving Project"
subtitle: "Assignment 2"
author: Bryan Yu - bryanyu@tamu.edu
output: pdf_document
---

## 0. Data prep

```{r setup, echo=FALSE, message=FALSE, cache=TRUE}

library(here)
library(conflicted)
library(dplyr)
library(purrr)
library(ggplot2)

```

```{r data_import, cache=TRUE, echo=FALSE}

dir_path <- here::here("data")
subject <- dir_path %>% dir() %>% stringr::str_match('T[0-9]{3}')
file_paths <- purrr::map(dir(here::here("data")), function(file_name) c(here::here("data", file_name)))
index_data <- readxl::read_excel(here::here("etc", "Dataset-Table-Index.xlsx")) %>%
    dplyr::filter(stringr::str_detect(Subject, 'T[0-9]{3}'))
subject_bio <- index_data %>% 
    dplyr::filter(!is.na(Gender)) %>%
    dplyr::select(subject=Subject, gender=Gender, age_group=`Age Group`)
subject_test <- index_data %>%
    dplyr::select(subject=Subject, session=Session, FACS, eye)
drive_map <- c(1:8)
names(drive_map) <- c("BL", "PD", "RD", "ND", "CD", "ED", "MD", "FD")
phase_convert <- function(Time) {
    if (Time < 80) { return(1)
    } else if (Time >= 80 & Time < 80 + 160) { return(2)
    } else if (Time >= 80 + 160 & Time < 80 + 160 + 240) { return(3)
    } else if (Time >= 80 + 160 + 240 & Time < 80 + 160 + 240 + 160) { return(4)
    } else { return(5) }
}
tp_files <- dir(here::here("structured_study_data"),
                pattern="*.tp", recursive=TRUE, full.names=TRUE)
tp_subjects <- stringr::str_match(tp_files, "(T[0-9]{3}).tp")[, 2]
tp_data <- purrr::map(tp_files, readLines, warn=FALSE) %>%
    purrr::set_names(tp_subjects) %>%
    dplyr::bind_rows(.id="subject") %>%
    tidyr::gather(subject, personality)
tai_data <- tp_data %>% 
    dplyr::filter(stringr::str_detect(personality, 'TAI')) %>%
    dplyr::mutate(tai=as.numeric(stringr::str_replace(personality, "TAI:", ""))) %>%
    dplyr::select(-personality)
typeab_data <- tp_data %>% 
    dplyr::filter(stringr::str_detect(personality, 'Type AB:')) %>%
    dplyr::mutate(type_ab=as.numeric(stringr::str_replace(personality, "Type AB:", ""))) %>%
    dplyr::select(-personality)
psych_df <- dplyr::inner_join(tai_data, typeab_data, by="subject")
rm(tp_files, tp_subjects, tp_data, tai_data, typeab_data)    
df <- purrr::map(file_paths, read.csv) %>% 
    purrr::set_names(subject) %>% 
    dplyr::bind_rows(.id = "Subject")
df$Drive <- names(drive_map[df$Drive])
df$phase <- purrr::map_dbl(df$Time, phase_convert)
df_feather <- df %>% 
    dplyr::filter(Drive %in% c("ND", "MD")) %>%
    dplyr::mutate(phase = as.factor(phase))
subject_df <- subject_bio %>% dplyr::inner_join(psych_df, by=c("subject"= "subject"))
df <- df_feather %>%  dplyr::select(
    Subject, Time, Distance, Lane.Position, LaneOffset, Drive, Stimulus, 
    Gaze.X.Pos, Gaze.Y.Pos, Lft.Pupil.Diameter, Rt.Pupil.Diameter)
#feather::write_feather(df_feather, here::here("study_df", "df.feather"))
feather::write_feather(df, here::here("study_df", "df_select.feather"))
#feather::write_feather(subject_df, here::here("study_df", "subject_df.feather"))
#rm(subject_bio, psych_df, subject, df_feather)
#rm(file_paths, dir_path, index_data, phase_convert, drive_map)

```

```{r gaze}

```


```{r facs_files}
facs_files <- dir(here::here("structured_study_data"),
                 pattern="*.FACS", recursive=TRUE, full.names=TRUE)
nd_files <- facs_files[stringr::str_detect(facs_files, "ND")]
md_files <- facs_files[stringr::str_detect(facs_files, "MD")]

nd_subjects <- stringr::str_match('T0[0=9]{2}')
md_subjects <- stringr::str_match('T0[0=9]{2}')

col_names <- c('Frame', 'Time', 'Anger', 'Contempt', 'Disgust',
               'Fear', 'Joy', 'Sad', 'Surprise', 'Neutral')

nd_facs_df <- purrr::map(nd_files, readxl::read_xlsx,
                         skip=9,
                         col_types=c(rep("numeric", 10)),
                         col_names=col_names) %>%
    set_names(nd_subjects)  %>%
    dplyr::bind_rows(.id = "subject")

md_facs_df <- purrr::map(md_files, readxl::read_xlsx,
                         skip=9,
                         col_types=c(rep("numeric", 10)),
                         col_names=col_names) %>%
    set_names(md_subjects) %>%
    dplyr::bind_rows(.id = "subject")

feather::write_feather(nd_facs_df, here::here("study_df", "facs_nd.feather"))
feather::write_feather(md_facs_df, here::here("study_df", "facs_md.feather"))
rm(facs_files, nd_files, md_files, nd_subjects, md_subjects)
```

```{r, echo=FALSE}
nd_nolanechange <- df %>% 
    dplyr::filter(Drive=="ND") %>% 
    dplyr::filter(!dplyr::between(Distance, 5000, 7000))
md_nolanechange <- df %>% 
    dplyr::filter(Drive=="MD") %>% 
    dplyr::filter(!dplyr::between(Distance, 5000, 7000))
```

## 1. Summary

Focused more on data preparation and some preliminary analysis of data as well as setting up an initial model.

**Modeling**

In order to familiarize myself with `Stan` and bayesian modeling, initial implementation focused on investigating the variation of the normal driving mode without the distracted driving term from Experiment 1$^1$. Future models will incorporate the distracted driving as a separate intercept term. 

**Data set issues**

Dr. Akleman noted last week that facial expression would useful to incorporate into the model. Due to data size constraints (57.5 GB), imported data into S3 and extracted \*.FACs data. Will add to model in the future during feature engineering phase.


## 2. Observations

```{r, echo=FALSE}
ggplot(df, aes(x=Distance, y=Lane.Position)) +
    geom_line(aes(colour=phase)) +
    facet_grid(Drive ~ .) +
    theme_bw() +
    labs(x = 'Distance', y = 'Lane Position (m)') +
    theme(legend.position = "bottom")

ggplot(nd_nolanechange %>% 
           dplyr::inner_join(subject_df, by=c("Subject"="subject")),
       aes(x=Distance, y=Lane.Position)) + 
    geom_point(aes(color=age_group), size=0.001) +
    theme_bw() +
    labs(x = 'Distance', y = 'Lane Position (m)') +
    theme(legend.position = "bottom")
```

1. Lane deviation appears stationary, no growth/decay trend appears evident. Candidate for stochastic volatility model similar to financial returns for the return of an asset in discrete time$^2$. 

2. Heavy tails in the distracted driving segment

3. Changepoints will be useful to incorporate known differences in behavior (phases of driving / lane change). However, timing does not appear to follow phases as described in Experiment 1 description.

## 3. Data Quality

* Missing eye tracking data for the following subjects:

```{r, echo=FALSE, message=FALSE} 
missing_eyes <- subject_test %>% 
    dplyr::filter(eye==0 & (session=='ND' | session=='MD')) %>% 
    distinct(subject)
missing_eyes$subject
```

* Missing FAC data for the following subjects:

```{r, echo=FALSE, message=FALSE} 
missing_facs <- subject_test %>% 
    dplyr::filter(FACS==0 & (session=='ND' | session=='MD')) %>% 
    distinct(subject)
missing_facs$subject
```

* Data not properly labelled in the `Structured Study Data` for the following drives T018-5/6, T020-4/7 and missing T026-6:

* Data is described as randomized order for 4-7 loaded drives but in the R-Friendly Dataset, order of drives is not randomized

* Missing lane position data for T060 / T061 in the Structured Data Set

## 4. Current model
### 4.1 A simple model
#### 1. Conceptual analysis

68 drivers from two different age groups and genders with pupil dilation recorded at each point in space. Lane position is recorded at each point of distance and with likely little change in the normal driving scenario after not including the lane change.

#### 2. Define Observations
```{r}
writeLines(readLines(here("src", "stan", "nd_no_lanechange.stan"), n=5))
```

#### 3. Identify relevant summary statistics 

The standard deviation will be a useful summary statistic. Given the 4 lane highway, it would be possible but unlikely to see lane positions change by more than 4 meters, especially without a lane change. Might be able to see differences based on age.

```{r, echo=FALSE}
mean_lane <- function(df) mean(df$Lane.Position, na.rm=TRUE)
sd_lane <- function(df) sd(df$Lane.Position, na.rm=TRUE)

mean_leye <- function(df) sd(df$Rt.Pupil.Diameter, na.rm=TRUE)
mean_reye <- function(df) sd(df$Lft.Pupil.Diameter, na.rm=TRUE)

nd_nest <- nd_nolanechange %>% group_by(Subject) %>% tidyr::nest() %>%
    inner_join(subject_df, by=c("Subject" = "subject")) %>%
    mutate(avg_lane=map_dbl(data, mean_lane), 
           sd_lane=map_dbl(data, sd_lane),
           r_dilation=map_dbl(data, mean_reye),
           l_dilation=map_dbl(data, mean_leye))
nd_nest %>% group_by(age_group) %>% summarize(mean(avg_lane), mean(sd_lane))
rm(mean_lane, mean_leye, mean_reye, sd_lane)
```

A multilevel model with age cohort as an intercept to model.

$$y_n \sim \mathcal{N}(\mu_n, \sigma_n)$$
$$\mu_n\sim \mu_0+ \mu_{age} $$

where $n \in \{ 1, \ldots, 68 \}$ and $j =$ distance

## 5. Questions

1. What is lane offset? Not specified in the description 

**References**

1. Taamneh, S. et al. *A multimodal dataset for various forms of distracted driving.* Sci. Data 4:170110 doi: 10.1038/sdata.2017.110 (2017). 
2. Stan Development Team (2017) *Stan Modeling Language: User's Guide and Reference Manual* Version 2.17.0 (2017), 10.5
```
