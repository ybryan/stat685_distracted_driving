---
title: "STAT 685: Distracted Driving"
subtitle: "Assignment 4"
author: "Bryan Yu: bryanyu@tamu.edu"
output: html_document
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(cache = TRUE)

library(rstan)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(grid)
library(here)
library(foreach)
library(doParallel)

source(here::here("src", "codebase", "helper.R"))
source(here::here("src", "codebase", "stan_utility.R"))
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

df_select <- feather::read_feather(here::here("study_df", "df_select.feather"))
subject_df <- feather::read_feather(here::here("study_df", "subject_df.feather"))

no_lane_df <- df_select %>% 
    dplyr::filter(!dplyr::between(Distance, 5000, 7000)) %>% # Remove lane change
    dplyr::filter(Distance > 250) %>%         # Remove driver starts
    dplyr::filter(Distance < 11000) %>%       # Remove driver ends
    dplyr::inner_join(subject_df, by=c("Subject"="subject"))

nd_nolanechange <- no_lane_df %>%  dplyr::filter(Drive == "ND") 
md_nolanechange <- no_lane_df %>%  dplyr::filter(Drive == "MD") 

gaze_nd <- nd_nolanechange %>%
    dplyr::group_by(Subject, Drive, gender, age_group, tai, type_ab) %>%
    dplyr::summarize(sd_lane_pos=sd(Lane.Position, na.rm = TRUE),
              sd_log_lane_pos=log(sd(Lane.Position, na.rm = TRUE)),
              sd_y_gaze=sd(Gaze.Y.Pos, na.rm = TRUE),
              sd_log_y_gaze=log(sd(Gaze.Y.Pos, na.rm=TRUE))) %>%
    dplyr::filter(!is.na(sd_y_gaze))

gaze_md <- md_nolanechange %>%
    dplyr::filter(Stimulus != 0) %>%
    dplyr::group_by(Subject, Drive, gender, age_group, tai, type_ab) %>%
    dplyr::summarize(sd_lane_pos=sd(Lane.Position, na.rm = TRUE),
              sd_log_lane_pos=log(sd(Lane.Position, na.rm = TRUE)),
              sd_y_gaze=sd(Gaze.Y.Pos, na.rm = TRUE),
              sd_log_y_gaze=log(sd(Gaze.Y.Pos, na.rm=TRUE))) %>%
    dplyr::filter(!is.na(sd_y_gaze))

seed <- 1000
rm(df_select)
```
```{r colors, echo=FALSE, cache=TRUE}
c_light <- c("#DCBCBC")
c_light_highlight <- c("#C79999")
c_mid <- c("#B97C7C")
c_mid_highlight <- c("#A25050")
c_dark <- c("#8F2727")
c_dark_highlight <- c("#7C0000")
```

## Objective: 
Model volatility of lane positioning with regards to texting effect and population effects (age cohort)

## Summary

**Assignment 2-3:** 
Linear regression on aggregated data set (per driver & drive, modelling standard deviation of lane positioning) and found divergence with model. The standard deviation of eye gaze and different population cohorts is inadequate to understanding the volatility of lane positioning. (Not included in this report to keep report concise)

**Assignment 4**:
Focused this analysis on driver T001 with time-series AR(1) in the sensorimotor driving (MD) section with phase 1 and 2 with bayesian posterior distribution checks. I had some difficulties with using generative model on covariates in the time series model but believe I can solve this with more time.

*Future steps*

1. Iterate on time series model with adding a stochastic volatilty model or heteroscedastic model (ARCH).
    
    * Handle '0' data on eye gaze more effectively, bi-modal/tri-modal mixture of blinking / distraction / eyes on road
    * log volatility
    * persistence of volatility
    * log volatility at distance d

3. Change-point model (account for driving phases)

4. Inference for all drivers \newline

*Questions*:

Not sure what the sampling rate is and it's not time. Should this data be averaged over specific distance points?


```{r preplot, echo=FALSE, cache=TRUE, fig.align="center", fig.height=3}
nd_plot <- ggplot(nd_nolanechange, aes(Distance, Lane.Position)) +
    geom_line(aes(colour=Subject)) + theme_bw() + 
    theme(legend.position = "none") + ylim(-5.5, 8) + ggtitle("Normal Driving (ND)")
md_plot <- ggplot(md_nolanechange, aes(Distance, Lane.Position)) +
    geom_line(aes(colour=Subject)) + theme_bw() + 
    theme(legend.position = "none") + ylim(-5.5, 8) + ggtitle("Sensorimotor Driving (MD)")
grid.arrange(nd_plot, md_plot, ncol=2)
rm(nd_plot, md_plot)
```

\newpage

## Data Analysis

Lane change removed and red indicating areas of stimulus (texting)

```{r plot, echo=FALSE, cache=TRUE, fig.height=5}
par(mfrow=c(2, 2))
t001_nd <- nd_nolanechange[nd_nolanechange$Subject=="T001", ]
t001_md <- md_nolanechange[md_nolanechange$Subject=="T001", ]
t001_md_stim <- t001_md[t001_md$Stimulus != 0, ]

plot(t001_nd$Distance, t001_nd$Gaze.Y.Pos,
     main="Normal driving: Driver 001", 
     xlab="Distance", ylab="Eye Gaze (Y)", pch=20)
plot(t001_md$Distance, t001_md$Gaze.Y.Pos, 
     main="Texting driving: Driver 001", 
     xlab="Distance", ylab="Eye Gaze (Y)", pch=20)
points(t001_md_stim$Distance, t001_md_stim$Lane.Position, col="red")

plot(t001_nd$Distance, t001_nd$Lane.Position, 
     main="Normal driving: Driver 001", 
     xlab="Distance", ylab="Lane Position", ylim=c(1, 3), pch=20)
plot(t001_md$Distance, t001_md$Lane.Position, 
     main="Texting driving: Driver 001", 
     xlab="Distance", ylab="Lane Position", ylim=c(1, 3), pch=20)
points(t001_md_stim$Distance, t001_md_stim$Lane.Position, col="red")
par(mfrow=c(1, 1))
```

* In distance 3500-5000 autoregressive behavior, whereas later distance appears more stochastic volatility model.
* Very different behavior after the lane change, currently only reviewing prior to the lane change. 
* Looks like two different models will be necessary (prior to lane change, and post lane change) 
\newline

```{r acf, echo=FALSE, cache=TRUE, fig.height=3}
t001_md_first <- t001_md[t001_md$Distance < 6000 & t001_md$Distance > 1, ]
acf(t001_md_first$Lane.Position, main="Driver T001 MD: Prior to lane change")
```

\newpage

## Modeling

### AR(1)

Remove first positions where `Lane.Position` is constant for first few observations.

#### Probability model (priors and likelihood)

$$y_t \sim \mathcal{N}(\alpha + \beta y_{n-1}, \sigma)$$

$$\alpha \sim \mathcal{N}(1.825, 0.05)$$

$$\beta \sim \mathcal{N}(0, 0.5)$$

$$\sigma \sim \mathcal{N}(0, 2)$$

### Simulated data

```{r prior_dens}
beta <- seq(0, 1, 0.001)
plot(beta, dnorm(beta, 0.5, 0.5), type="l", col=c_dark_highlight, lwd=2,
     xlab="beta", ylab="Prior Density", yaxt="n")
lambda99 <- seq(0, 1, 0.001)
dens <- dnorm(lambda99, 0.5, 0.5)

lambda99 <- c(0, lambda99, 1)
dens <- c(0, dens, 0)
polygon(lambda99, dens, col=c_dark, border=NA)
```

```{r gen}
K <- 1

gen_ar1 <- stan(here("src", "stan", "gen_arK.stan"),
                iter=1000, refresh=1000, warmup=0, chains=1, 
                 algorithm="Fixed_param", seed=seed)
```


#### Estimate model with actual data

```{r ar1, echo=FALSE, cache=TRUE, include=FALSE}
K <- 1
T <- length(t001_md_first$Lane.Position)
y <- t001_md_first$Lane.Position

ar1_fit <- rstan::stan(here::here("src", "stan", "arK.stan"),
                       data=list(K, T, y),
                       seed=seed, refresh=1000)
```

**Diagnostics**
```{r ar1_diag, echo=FALSE, cache=TRUE}
check_all_diagnostics(ar1_fit)
```

**Parameters**
```{r ar1_params, echo=FALSE, cache=TRUE}
ar1_summary <- summary(ar1_fit, pars = c("alpha", "beta", "sigma"), probs = c(0.1, 0.5, 0.9))$summary
params <- rstan::extract(ar1_fit)
print(ar1_summary)
```

\newpage
**Posterior Predictive Distribution (correlogram)**
```{r ar1_fit, echo=FALSE, cache=TRUE, fig.align="center"}
B <- 25
idx <- rep(0:B, each=2)
x <- sapply(1:length(idx), 
            function(b) if(b %% 2 == 0) idx[b] + 0.5 else idx[b] - 0.5)

acfs <- sapply(1:4000, function(n) acf(params$y_ppc[n, ], lag.max=B, plot=FALSE)$acf)
probs = c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9)
cred <- sapply(1:(B + 1), function(b) quantile(acfs[b,], probs=probs))

pad_cred <- do.call(cbind, lapply(idx, function(n) cred[1:9,n + 1]))

acf_fit <- acf(t001_md_first$Lane.Position, lag.max=25, main="T001 Texting")
polygon(c(x, rev(x)), c(pad_cred[1,], rev(pad_cred[9,])),
        col = c_light, border = NA)
polygon(c(x, rev(x)), c(pad_cred[2,], rev(pad_cred[8,])),
        col = c_light_highlight, border = NA)
polygon(c(x, rev(x)), c(pad_cred[3,], rev(pad_cred[7,])),
        col = c_mid, border = NA)
polygon(c(x, rev(x)), c(pad_cred[4,], rev(pad_cred[6,])),
        col = c_mid_highlight, border = NA)
lines(x, pad_cred[5,], col=c_dark, lwd=2)
```

## AR(1) with covariates (Distracted + eye gaze)

$$y_n \sim \mathcal{N}(\alpha + \beta y_{n-1}, \sigma)$$

$$\beta \sim \beta_0 + \beta_i + \gamma * j_{n-1}$$

$i:$ Distracted

$j:$ Eye gaze