---
#title: "distracted_driving_workflow"
output: html_document
---

```{r data, message=FALSE}
library(ggplot2)
library(magrittr)
library(dplyr)
library(rstan)

df_feather <- feather::read_feather(here::here("study_df", "df.feather"))
subject_bio <- feather::read_feather(here::here("study_df", "subject_bio.feather"))

df <- df_feather %>% 
    dplyr::select(Subject, Distance, Lane.Position, Drive, phase,
                  Gaze.X.Pos, Gaze.Y.Pos, Lft.Pupil.Diameter, Rt.Pupil.Diameter,
                  gender, age_group, tai, type_ab) %>%
    dplyr::mutate(age_group=as.factor(age_group),
                  gender=as.factor(gender),
                  Drive=as.factor(Drive))

nd_df <- df %>% dplyr::filter(Drive == "ND") 
md_df <- df %>% dplyr::filter(Drive == "MD") 
nd_nolanechange <- nd_df %>% dplyr::filter(!dplyr::between(Distance, 5000, 7000))
md_nolanechange <- md_df %>% dplyr::filter(!dplyr::between(Distance, 5000, 7000))
source(here::here('src', 'codebase', 'stan_utility.R'))
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

```{r}
str(df)
```

## Objective

- Determine how lane deviation volatility is affected by sensorimotor driving (MD), aka texting while driving, compared to normal driving (ND)
    - Phases proceeding stimulus

- Eye gazing / pupilation are explanatory variables to lane positioning / volatility

- Compare lane deviation volatility by cohorts (age, gender, psychometric survey)

```{r, warning=FALSE, fig.align="center", echo=FALSE}
ggplot(df, aes(x=Distance, y=Lane.Position)) +
    geom_line(aes(colour=phase)) +
    facet_grid(Drive ~ .) +
    theme_bw() +
    labs(x = 'Distance', y = 'Lane Position (m)') +
    theme(legend.position = "bottom")
```

## Model 1.0: First down

Trying to capture normal driving behavior without lane change and with age cohort and pupil dilation

```{r, echo=FALSE, fig.align="center"}
ggplot(nd_nolanechange, aes(x=Distance, y=Lane.Position)) + 
    geom_line(aes(color=Subject)) +
    facet_grid(. ~ age_group)  +
    theme_bw() +
    labs(x = 'Distance', y = 'Lane Position (m)') +
    theme(legend.position = "none")
```

$$y_n(i) \sim \mathcal{N}(\mu_n, \sigma_n)$$

$$\mu_n\sim \alpha+ \mu_{age} + \beta x_i$$

where $n \in \{ 1, \ldots, 68 \}$, $i:$ Distance, and $x_i$: pupil dilation

Assuming pupil dilation is matched evenly, picking right eye for simplicity.

### 1. Conceptual analysis

68 drivers from two different age groups and genders with pupil dilation recorded at each point in space (distance). Lane position is recorded at each point of distance and with likely little change in the normal driving scenario after not including the lane change.

### 2. Define Observations
```{r}
writeLines(readLines(here::here("src", "stan", "nd_no_lanechange.stan"), n=7))
```

### 3. Identify relevant summary statistics 

The standard deviation will be a useful summary statistic. Given the 4 lane highway, it would be possible but unlikely to see lane positions change by more than 4 meters, especially without a lane change. Might be able to see differences based on age.

```{r, echo=FALSE, message=FALSE}
library(dplyr)
library(purrr)

mean_lane <- function(df) mean(df$Lane.Position, na.rm=TRUE)
sd_lane <- function(df) sd(df$Lane.Position, na.rm=TRUE)

mean_leye <- function(df) sd(df$Rt.Pupil.Diameter, na.rm=TRUE)
mean_reye <- function(df) sd(df$Lft.Pupil.Diameter, na.rm=TRUE)

nd_nest <- nd_nolanechange %>% group_by(Subject) %>% tidyr::nest() %>%
    inner_join(subject_bio, by=c("Subject" = "subject")) %>%
    mutate(avg_lane=map_dbl(data, mean_lane), 
           sd_lane=map_dbl(data, sd_lane),
           r_dilation=map_dbl(data, mean_reye),
           l_dilation=map_dbl(data, mean_leye))
nd_nest %>% group_by(age_group) %>% summarize(mean(avg_lane), mean(sd_lane))
rm(mean_lane, mean_leye, mean_reye, sd_lane)
```

### 4. Build a generative model

Each lane is 3.65m and is measured from right edge of the rightmost lane, so $\mu_0 \sim \mathcal{N} (1.825, .25).

```{r}

```

### 5. Analyze the generative ensemble
### 6. Fix the observations and evaluate

How to incorporate different number of pupil values?

```{r}
stan(file=here::here("src", "stan", "nd_no_lanechange.stan"))
```


### 7. Posterior Predictive


## Model 2.0: Different perspective

Relevant summary statistics should include autocorrelation term. It seems obvious now that drivers are continually correcting for drift by knowing their previous lane position and adjusting to stay in the middle of the lane.



## Questions:

1. How to deal with missing data?
    * Incorrect data (0 for eye pupil)
2. How to incorporate different number of pupil values / distance values?