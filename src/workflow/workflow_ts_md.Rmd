---
title: "Distracted Driving: Time Series Workflow"
author: "Bryan Yu"
output: 
  html_document: 
    fig_caption: yes
    theme: spacelab 
    highlight: pygments
    toc: true
    toc_depth: 3
    number_sections: TRUE
    toc_float: 
      smooth_scroll: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(cache = TRUE)
library(ggplot2)
library(gridExtra)
library(grid)
library(dplyr)
library(here)
library(rstan)
library(foreach)
library(doParallel)

util <- new.env()
source(here::here('src', 'codebase', 'stan_utility.R'), local=util)
source(here("src", "codebase", "helper.R"))

c_light <- c("#DCBCBC")
c_light_highlight <- c("#C79999")
c_mid <- c("#B97C7C")
c_mid_highlight <- c("#A25050")
c_dark <- c("#8F2727")
c_dark_highlight <- c("#7C0000")
load(here("data", "md_half.RData"))
```
# Single driver (T021): Texting

## AR(1) of Normal driving (ND)
## AR(1) of Texting driving (MD)
## ARCH(1) of Texting driving (MD)

$$\alpha_i: \textrm{Texting indication}$$

$$y_t \sim \mathcal{N}(\mu, \sqrt{\alpha_0 + \alpha_i (y_{t-1} - \mu)^2} )$$

### Conceptual Analysis

Single driver staying in the middle of a lane (3.65m wide) with variance dependent on previous postion (further from middle -> more variance back to middle) and dependent on if the driving is texting
``` {r 1.3.1}
md_lane <- ggplot(md_half, aes(Distance, Lane.Position)) +
    geom_line() +
    geom_point(aes(colour=Stimulus), size=0.25) +
    theme_bw() + 
    theme(legend.position = "none") + 
    ggtitle("Texting Driving (MD)") +
    xlab("Distance (m)") + 
    ylab("Lane Position(m)") +
    coord_cartesian(ylim=c(1.5, 2.5)) +
    scale_color_hue(labels=c("None", "Texting"))
```

### Define observations

$$N: \textrm{Number of observations}$$

$$y_n: \textrm{Lane Position (meters)}$$
$$x_n: \textrm{Normal (1) vs Texting (2)}$$

```{r 1.3.2}
writeLines(readLines(here("src", "stan", "arch1_texting.stan"), n=5))
```

### Identify relevant summary statistics

Use correlogram as summary statistic

### Build a generative model
```{r 1.3.4, fig.height=2}
par(mfrow=c(1, 3))
# mu
mu <- seq(0, 3.65, 0.001)
plot(mu, dnorm(mu, 1.825, 0.5), type="l", col=c_dark_highlight, lwd=2, xlab="mu", ylab="Prior Density", yaxt='n')
mu99 <- seq(0, 3.65, 0.001)
dens <- c(dnorm(mu99, 1.825, 0.5), 0, 0)
polygon(c(mu99, 3.65, 0), dens, col=c_dark, border=NA)

# alpha0
alpha0 <- seq(0, 3, 0.001)
plot(alpha0, dexp(alpha0, 1.273), type="l", col=c_dark_highlight, lwd=2, xlab="alpha_0", ylab="Prior Density", yaxt='n')
alpha0_99 <- seq(0, 3, 0.001)
dens <- c(dexp(alpha0_99, 1.273), 0, 0)
polygon(c(alpha0_99, 3, 0), dens, col=c_dark, border=NA)

# alpha1
alpha1 <- seq(-2, 2, 0.001)
plot(alpha1, dnorm(alpha1, 0, 0.5), type="l", col=c_dark_highlight, lwd=2, xlab="alpha_1", ylab="Prior Density", yaxt='n')
alpha1_99 <- seq(-2, 2, 0.001)
dens <- c(dnorm(alpha1_99, 0, 0.5), 0, 0)
polygon(c(alpha1_99, 2, -2), dens, col=c_dark, border=NA)
par(mfrow=c(1, 1))
```

### Analyze the generative ensemble
```{r 1.3.5a, echo=TRUE, results="hide"}
R <- 1000
simu_data <- list("T" = length(md_half$Lane.Position),
                  "texting" = as.integer(md_half$Stimulus))
fit <- stan(here("src", "stan", "gen_arch1_texting.stan"), 
            data=simu_data, iter=R, warmup=0, chains=1, refresh=R, seed=1000,
            algorithm="Fixed_param")

simu_mus     <- extract(fit)$mu 
simu_alpha0s <- extract(fit)$alpha0
simu_alpha1s <- extract(fit)$alpha1
simu_alpha_texting <- extract(fit)$alpha_texting
simu_ys      <- extract(fit)$y
good_inx     <- which(simu_mus != 0)
```

#### Analyze the prior predictive distribution
```{r 1.3.5b}
B <- 24
counts <- sapply(good_inx, function(r) acf(simu_ys[r,], plot=FALSE)$acf)
probs <- c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9)
cred <- sapply(1:B, function(b) quantile(counts[b, ], probs=probs))

idx <- rep(1:B, each=2)
x <- sapply(1:length(idx), function(b) if(b %% 2 == 0) idx[b] + 0.5 else idx[b] - 0.5)
pad_cred <- do.call(cbind, lapply(idx, function(n) cred[1:9, n]))

plot(1, type="n", main="Prior Predictive Correlogram",
     xlim=c(0.5, B + 0.5), xlab="y", ylim=c(0, max(cred[9,])), ylab="")
 
polygon(c(x, rev(x)), c(pad_cred[1,], rev(pad_cred[9,])),
        col = c_light, border = NA)
polygon(c(x, rev(x)), c(pad_cred[2,], rev(pad_cred[8,])),
        col = c_light_highlight, border = NA)
polygon(c(x, rev(x)), c(pad_cred[3,], rev(pad_cred[7,])),
        col = c_mid, border = NA)
polygon(c(x, rev(x)), c(pad_cred[4,], rev(pad_cred[6,])),
        col = c_mid_highlight, border = NA)
lines(x, pad_cred[5,], col=c_dark, lwd=2)

rm(B, counts, cred, idx, x, pad_cred)
```
### Fit the observations and evaluate

```{r 1.3.6a, fig.height=3, results="hide"}
input_data <- list("T" = length(md_half$Lane.Position),
                  "texting" = as.integer(md_half$Stimulus),
                  "y" = md_half$Lane.Position)
fit <- stan(file=here('src', 'stan', 'arch1_texting.stan'), data=input_data,
                      seed=493483, refresh=2000)
util$check_all_diagnostics(fit)
params <- extract(fit)
```