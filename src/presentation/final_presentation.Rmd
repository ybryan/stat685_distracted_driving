---
title: "STAT 685: Distracted Driving"
subtitle: "Committee: Dr. Derya Akleman, Dr. Samiran Sinha, Dr. Ergun Akleman"
author: "Bryan Yu | bryanyu@tamu.edu"
date: "Summer 2018"
output: 
    powerpoint_presentation:
      reference_doc: template.potx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(cache = TRUE)
library(dplyr)
library(here)
library(ggplot2)
library(feather)
library(aws.s3)
library(bayesplot)
library(knitr)
library(rstan)
library(kableExtra)
library(stringr)
library(gridExtra)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write=TRUE)
aws.signature::use_credentials(profile = "ybryan")

util <- new.env()
source(here('src', 'codebase', 'stan_utility.R'), local=util)
colors <- list(c_light=c("#DCBCBC"), c_light_highlight=c("#C79999"),
               c_mid=c("#B97C7C"),   c_mid_highlight=c("#A25050"),
               c_dark=c("#8F2727"),  c_dark_highlight=c("#7C0000"),
               d_light=c("#BCBCDC"), d_light_highlight=c("#9999C7"),
               d_mid=c("#7C7CB9"),   d_mid_highlight=c("#5050A2"),
               d_dark=c("#27278F"),  d_dark_highlight=c("#00007c"))
```

## About me: *Bryan Yu*
:::::::::::::: {.columns}
::: {.column}

![](/Users/bryanyu/Dropbox/STATS/STAT685/etc/pix/IMG_3644.png)

:::
::: {.column}

○ Currently work in finance (data analyst/engineer) in Austin, TX

○ Graduated from UT-Austin 2009, BS Aerospace Engineering

○ Spent 4 years on the west coast but moved back to Texas in 2015

○ Interests

  - **Intellectual:** Econometrics
  - **Personal:** Weightlifting and calisthenics 
  - **Graduation Present:** Dog

:::
::::::::::::::
## Experiment
:::::::::::::: {.columns}
::: {.column}
- Controlled simulated driving experiment^[1](https://www.nature.com/articles/sdata2017110)^ to asses driving behavior

- Multiple different stressors: cognitive, emotional, sensorimotor (texting)

- Each driver (N=68) had 4 different drives to assess stressors including control

- Sensors captured vehicle information and driver outputs

- Subject variables: age, gender, personality

- Drive variables: Speed, brake, lane position

- Biological variables: eye gaze, heart rate, breathing rate, etc
:::
::: {.column}
![](https://media.nature.com/lw926/nature-assets/sdata/2017/sdata2017110/images_hires/sdata2017110-f1.jpg)
:::
::::::::::::::

## Project Objective

- Model variance of lane positioning to quantify texting effect

- Explore population level effects on variance
  - Age, Gender, Personality (Type AB, Anxiety score)

- Bayesian modelling

    - Time series analysis
    - [Stan](http://mc-stan.org/) MCMC Programming: Sampling with Hamiltonian Monte Carlo
    - ["Modern Statistical Workflow"](https://modernstatisticalworkflow.blogspot.com/2016/08/what-is-modern-statistical-workflow.html)^2^: Capture simulated data before fitting observations
    
## Data Preparation
:::::::::::::: {.columns}
::: {.column}
- Focused only on the sensorimotor (MD) / texting drive

- Focused on first half (prior to lane change)

- Filtered out drivers with missing `LaneOffset` data (N=62)

- Data downsampled to 200 data points per driver

  - 62 drivers * 200 datapoints = 12,400 records

- Each color is a separate driver (N=68)

- Some drivers exhibit extremely long tails in their lane positioning

:::
::: {.column}
```{r prelim_plot_all, fig.width=8, fig.height=6}
df_md <- feather::read_feather(here::here('etc', 'cleaner_data', 'df_select.feather'))
rect <- data.frame(xmin=5000, xmax=Inf, ymin=-Inf, ymax=Inf)
all_plot <- ggplot(df_md, aes(Distance, Lane.Position)) + 
  geom_line(aes(colour=Subject)) +
    geom_rect(data=rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              color="transparent", alpha=0.25, inherit.aes = FALSE) +
    geom_line(aes(colour=Subject)) + 
    theme_bw() + 
    theme(legend.position = "none") + 
    ggtitle("MD Drive") +
    xlab("Distance (m)") + 
    ylab("Lane Position(m)") +
    coord_cartesian(ylim=c(-5.5, 7)) +
    annotate("text", x=5750, y=0, label="Lane Change",
             angle=90, color="Red",  size=4, hjust=0) +
    annotate("text", x=1750, y=6.25, label="Model Focus",
             size=5, hjust=0, color="blue") 
all_plot
```
:::
::::::::::::::

## Preliminary Analysis: T021 Driver
:::::::::::::: {.columns}
::: {.column}

- Univariate (T021) data is stationary according to the Dickey-Fuller Test

  - Accounting for texting vs normal driving
  
- Higher variance in `LaneOffset` when driver is texting

- Data exhibits an autoregressive structure in the correlogram and plot of the `LaneOffset`

:::
::: {.column}

```{r prelim_plot_t021, fig.width=8, fig.height=6}
md_half <- readRDS(here('etc', 'cleaner_data', 'md_half_t021.RData'))
t021_plot <- ggplot(md_half, aes(Distance, LaneOffset)) +
    geom_line() +
    geom_point(aes(colour=Stimulus), size=1.5) +
    theme_bw() + 
    theme(legend.position = "right",
          legend.background = element_rect(
            fill="gray90", size=.5, linetype="dotted")) + 
    ggtitle("Texting Driving (T021 Driver)") +
    xlab("Distance (m)") + 
    ylab("Lane Offset (m)") +
    coord_cartesian(ylim=c(-0.75, .5)) +
    scale_color_manual(labels=c("No Distraction", "Texting"),
                       values=c(colors$c_mid_highlight, colors$d_mid_highlight))

conf.level <- 0.95
acf_md <- acf(md_half$Lane.Position, plot=FALSE)
acf_md_df <- with(acf_md, data.frame(lag, acf))
ciline <- qnorm((1 - conf.level)/2)/sqrt(
  length(md_half$Lane.Position))

t021_acf <- ggplot(acf_md_df, aes(lag, acf)) +
    geom_segment(aes(xend=lag, yend=0)) +
    geom_hline(aes(yintercept=0)) + 
    geom_hline(aes(yintercept= -ciline), linetype=2, color='darkblue') +
    geom_hline(aes(yintercept= ciline), linetype=2, color='darkblue') +
    theme_bw() + 
    theme(legend.position = "none") + 
    ggtitle("Texting Driving (T021 Driver)") +
    xlab("Lag") + 
    ylab("ACF")
grid.arrange(t021_plot, t021_acf, nrow=2)
rm(ciline, conf.level, acf_md, acf_md_df, md_half, t021_acf, t021_plot)
```
:::
::::::::::::::

## Preliminary Analysis: All drivers
:::::::::::::: {.columns}
::: {.column}

- Age effect appears to have significant interaction effect with texting (yellow)

- Gender and personality level effects (anxiety score, Type A/B) do not appear to have significant effects with regard to driving variance

- With a sample size of $N_{drivers} = 62$, not enough power to test other interactions
:::
::: {.column}
```{r prelim_plot_all_drivers, fig.width=8, fig.height=6}
md_half_all <- readRDS(here('etc', 'cleaner_data', 'md_half_df.RData'))
subject_df <- md_half_all %>% 
  group_by(Subject, gender, age_group, tai, type_ab) %>% 
  summarize(sd = sd(LaneOffset)) %>%
  select(Subject, gender, age_group, tai, type_ab)
input_data <- list("N_drivers" = length(unique(md_half_all$Subject)),
                   "N_age" = length(unique(md_half_all$age_group)),
                   "N_time" = 200,
                   "N" = 200 * length(unique(md_half_all$Subject)),
                   "N_texting" = 2,
                   "texting" = as.integer(md_half_all$Stimulus),
                   "age" = as.integer(as.factor(subject_df$age_group)),
                   "y" = md_half_all$LaneOffset)
agg_data <- md_half_all %>% group_by(Subject) %>% 
  summarize(sd = sd(LaneOffset)) %>%
  left_join(subject_df, by="Subject")

agg_data_stim <- md_half_all %>% group_by(Subject, Stimulus) %>% 
  summarize(sd = sd(LaneOffset)) %>%
  left_join(subject_df, by="Subject")

levels(agg_data_stim$Stimulus) <- c("Normal", "Texting")
p1 <- ggplot(agg_data, aes(type_ab, sd)) + geom_point() + xlab("Type AB")
p2 <- ggplot(agg_data, aes(tai, sd)) + geom_point() + xlab("Anxiety")
p3 <- ggplot(agg_data_stim, aes(gender, sd)) + geom_violin() + 
  facet_grid(. ~ Stimulus) + xlab("Gender")
p4 <- ggplot(agg_data_stim, aes(age_group, sd)) + geom_violin(fill="yellow") + 
  facet_grid(. ~ Stimulus) + xlab("Age Group")
grid.arrange(p4, p3, p1, p2, nrow = 2)
rm(p4, p3, p1, p2, agg_data, agg_data_stim, subject_df, input_data, md_half_all)
```
:::
::::::::::::::

## Modelling

:::::::::::::: {.columns}
::: {.column}
**Univariate model (T021 driver)**

○ AR(1): Texting effect

$$y_t \sim \textrm{Normal}(\alpha + \rho y_{t-1}, \sigma_0 + \delta_j_0)$$

**Multivariate model (all drivers)**

○ AR(1): Additive effects (pooled individuals)

$$\mu = \alpha + \rho y_{t-1, i}$$
$$\sigma = \sigma_0 + \sigma_i + \delta_j_0 + \delta_{j, i}$$
$$y_{t, i, j} \sim \textrm{N}(\mu, \sigma)$$

○ AR(1): Multiplicative effects (texting & age)

$$\sigma = \sigma_0 * exp \big[log (\sigma_{k}) + log(\sigma_{j, k}) \big]$$
$$y_{t, i, j, k} \sim \textrm{N}(\mu, \sigma)$$

:::
::: {.column}
$$y: \textrm{LaneOffset}$$
$$t: \textrm{Distance (n = 200)}$$
$$i: \textrm{Drivers (n = 62)}$$
$$j: \textrm{Texting (n = 2)}$$
$$k: \textrm{Age (n = 2)}$$


**Priors**

$$\alpha \sim \mathcal{N}(0, 1)$$
$$\rho \sim \textrm{Uniform}(0, 1)$$
$$\sigma_0, \delta_j_0 \sim \textrm{Half-normal}(0, 1)$$
$$\sigma_i, \delta_{j, i} \sim \textrm{Half-normal}(0, [\sigma_\gamma, \delta_\gamma ])$$
$$\sigma_\gamma, \delta_\gamma \sim \textrm{Half-normal}(0, 0.1)$$
$$log(\sigma_{j}), log(\sigma_{j, k}) \sim \textrm{N}(0, 1)$$

:::
::::::::::::::

## AR(1) Univariate: Results

:::::::::::::: {.columns}
::: {.column}
```{r ar1_fit_plot, fig.width=8, fig.height=6, warning=FALSE, message=FALSE}
fit <- readRDS(here("etc", "fits", "ar1_texting_stan_fit.RData"))
bayesplot_theme_set(theme_minimal())
posterior <- as.matrix(fit)
plot_title <- ggtitle("Posterior distributions (80% intervals)")
mcmc_areas(posterior, 
           pars = c("delta_texting", "sigma", "rho", "alpha"), 
           prob = 0.8) + plot_title +
  scale_y_discrete(
    breaks=c(
      "delta_texting", "sigma", "rho", "alpha"
      ),
    labels=c(
      bquote(delta[j[0]]),
      bquote(sigma[0]), 
      bquote(rho), 
      bquote(alpha)
      )) + 
  theme(axis.text.y = element_text(size=24))
  
```
:::
::: {.column}
```{r ar1_ppc_plot, fig.width=8, fig.height=6}
fit <- readRDS(here("etc", "fits", "ar1_texting_stan_fit.RData"))
md_half <- readRDS(here('etc', 'cleaner_data', 'md_half_t021.RData'))
input_data <- list("y" = md_half$LaneOffset,
                   "texting" = as.integer(md_half$Stimulus),
                   "N" = length(md_half$Lane.Position),
                   "N_texting" = length(unique(as.integer(md_half$Stimulus))))

post <- as.matrix(fit)
sel <- grep("y_ppc", colnames(post))
# compute the credible intervals
ci50 <- matrix(NA, nrow = length(sel), ncol = 2)
ci90 <- matrix(NA, nrow = length(sel), ncol = 2)
for (i in 1:length(sel)) {
  ci50[i,] <- quantile(post[,sel[i]], prob = c(0.25, 0.75), names = FALSE)
  ci90[i,] <- quantile(post[,sel[i]], prob = c(0.05, 0.95), names = FALSE)
}

plot(0, type= "n", 
     xlim = c(0, max(md_half$Distance)), ylim = c(-.6, .5),
     xlab = "Distance", ylab = "Lane Offset", 
     main = bquote("Posterior Predictive Check ("~y[t + 1]~")"))
t <- md_half$Distance
polygon(c(rev(t), t), c(rev(ci90[,1]), ci90[,2]), col = colors$c_light, border = FALSE)
polygon(c(rev(t), t), c(rev(ci50[,1]), ci50[,2]), col = colors$c_mid, border = FALSE)
t <- md_half$Distance[which(input_data$texting==2)]
i <- which(input_data$texting==2)
polygon(c(rev(t), t), c(rev(ci90[i,1]), ci90[i,2]), col = colors$d_light, border = FALSE)
polygon(c(rev(t), t), c(rev(ci50[i,1]), ci50[i,2]), col = colors$d_mid, border = FALSE)
lines(md_half$Distance, colMeans(post[,sel]), col = "hotpink", lwd = 3)
# plot true series
lines(md_half$Distance, input_data$y, col = "#0c120c", lwd = 2)
legend("bottomright", c("actual", "pred (avg)", "Normal", "Texting"),
       col = c("#0c120c", "hotpink", colors$c_mid, colors$d_mid),
       lwd = c(2,2,2), text.font=0.5)
rm(t, i, ci50, ci90, post, sel)
```
:::
::::::::::::::

## AR(1) Univariate: Diagnostics

:::::::::::::: {.columns}
::: {.column}
```{r ar1_univ_trace, fig.width=8, fig.height=8}
fit <- readRDS(here("etc", "fits", "ar1_texting_stan_fit.RData"))
bayesplot_theme_set(theme_minimal())
posterior <- as.array(fit)
plot_title <- ggtitle("Trace plots")
color_scheme_set("blue")
mcmc_trace(posterior, 
           pars = c("alpha", "rho", "sigma", "delta_texting"),
           ) + plot_title
```

:::
::: {.column}
```{r ar1_univ_pairs, fig.width=8, fig.height=6}
fit <- readRDS(here("etc", "fits", "ar1_texting_stan_fit.RData"))
bayesplot_theme_set(theme_minimal())
posterior <- as.array(fit)
color_scheme_set("blue")
mcmc_acf(posterior, 
           pars = c("alpha", "rho", "sigma", "delta_texting"))
```

:::
::::::::::::::

## AR(1) Multivariate Additive: Individual results

:::::::::::::: {.columns}
::: {.column}

- Large variation between individuals

- Clusters of population exist where the effect of texting and the base variation of lane offset correlate

- Drivers who have high variation in lane positioning have correspondingly higher variation when texting

:::
::: {.column}

```{r ar1_add, fig.width=8, fig.height=8, warning=FALSE, message=FALSE}
md_half_all <- readRDS(here('etc', 'cleaner_data', 'md_half_df.RData'))
subject_df <- md_half_all %>% 
  group_by(Subject, gender, age_group, tai, type_ab) %>% 
  summarize(sd = sd(LaneOffset)) %>%
  select(Subject, gender, age_group, tai, type_ab)
input_data <- list("N_drivers" = length(unique(md_half_all$Subject)),
                   "N_age" = length(unique(md_half_all$age_group)),
                   "N_time" = 200,
                   "N" = 200 * length(unique(md_half_all$Subject)),
                   "N_texting" = 2,
                   "texting" = as.integer(md_half_all$Stimulus),
                   "age" = as.integer(as.factor(subject_df$age_group)),
                   "y" = md_half_all$LaneOffset)
fit_pooled <- readRDS(
  file=here('etc', 'fits', 'ar1_texting_multi_pooled.RData')) 

posterior_pooled <- as.array(fit_pooled)
par_sigma_names <- dimnames(posterior_pooled)$parameters[
  which(!is.na(
    str_match(dimnames(posterior_pooled)$parameters, "sigma_driver\\[[:xdigit:]")))]
dimnames(posterior_pooled)$parameters[
  dimnames(posterior_pooled)$parameters %in% par_sigma_names] <- subject_df$Subject 
p1 <- mcmc_intervals(posterior_pooled, pars=subject_df$Subject) +
  ggtitle(bquote("Driver Lane position variation ("~sigma[i]~")"))

posterior_pooled <- as.array(fit_pooled)
par_delta_names <- dimnames(posterior_pooled)$parameters[
  which(!is.na(
    str_match(dimnames(posterior_pooled)$parameters, "delta_texting_driver\\[[:xdigit:]")))]
dimnames(posterior_pooled)$parameters[
  dimnames(posterior_pooled)$parameters %in% par_delta_names] <- subject_df$Subject 
p2 <- mcmc_intervals(posterior_pooled, pars=subject_df$Subject) +
  ggtitle(bquote("Text effect by driver ("~delta[i]~")"))
bayesplot_grid(p1, p2, grid_args=list(ncol = 2))
rm(p1, p2, md_half_all, subject_df, input_data, fit_pooled, posterior_pooled)
```
:::
::::::::::::::

## AR(1) Multivariate Additive: Hyperprior results

:::::::::::::: {.columns}
::: {.column}

- Pooling forces variability of the $\sigma_0$ and $\delta_{j_0}$ (red) to zero as variability is now within all the drivers

- Hyperprior distributions (blue) show that the texting effect doubles the lane position variance for the individual drivers

:::
::: {.column}

```{r ar1_add_hyper, fig.width=8, fig.height=5, warning=FALSE, message=FALSE}
fit_pooled <- readRDS(
  file=here('etc', 'fits', 'ar1_texting_multi_pooled.RData')) 
posterior_pooled <- as.array(fit_pooled, pars=c(
    "sigma_base", "delta_base",
    "sigma_driver_sigma", "delta_texting_driver_sigma"))

color_scheme_set("blue")
p1 <- mcmc_intervals(
  posterior_pooled,
  pars=c(
    "delta_texting_driver_sigma", "sigma_driver_sigma"
    )) +
  scale_y_discrete(
    breaks=c(
      "delta_texting_driver_sigma", "sigma_driver_sigma"
      ),
    labels=c(
      bquote(delta[gamma]),
      bquote(sigma[gamma]) 
      )) + 
  theme(axis.text.y = element_text(size=24))

color_scheme_set("red")
p2 <- mcmc_intervals(
  posterior_pooled,
  pars=c(
    "delta_base", "sigma_base"
    )) +
  scale_y_discrete(
    breaks=c(
    "delta_base", "sigma_base"
      ),
    labels=c(
      bquote(delta[0]),
      bquote(sigma[0])
      )) +
  theme(axis.text.y = element_text(size=24))
bayesplot_grid(p2, p1, xlim=c(0, 0.25), titles=c(
  "Base effect", "Hyperpriors (Individual effects)"))

rm(p1, p2, fit_pooled, posterior_pooled)
```
:::
::::::::::::::
## AR(1) Multivariate Additive: Diagnostics
:::::::::::::: {.columns}
::: {.column}
```{r ar1_multi_trace, fig.width=8, fig.height=6}
fit_pooled <- readRDS(
  file=here('etc', 'fits', 'ar1_texting_multi_pooled.RData')) 
posterior_pooled <- as.array(fit_pooled)
bayesplot_theme_set(theme_minimal())
plot_title <- ggtitle("Trace plots")
color_scheme_set("blue")
mcmc_trace(posterior_pooled, 
           pars = c("alpha", "rho", "sigma_base",
                    "sigma_driver_sigma", "delta_base", 
                    "delta_texting_driver_sigma")) +
  plot_title
```

:::
::: {.column}
```{r, fig.width=8, fig.height=6}
mcmc_acf(posterior_pooled, 
           pars = c("alpha", "rho", "sigma_base",
                    "sigma_driver_sigma", "delta_base",
                    "delta_texting_driver_sigma"))
```
:::
::::::::::::::

## AR(1) Multivariate Multiplicative: Results
:::::::::::::: {.columns}
::: {.column}

* Older drivers have higher lane position variance in both non-texting and texting situations

* The interaction effect between texting and the age group causes the posterior distribution to be much wider

* The large variation between individual drivers when texting contributes to the larger posterior of the texting effect

:::
::: {.column}
```{r, warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
fit_age <- readRDS(file=here('etc', 'fits', 'ar1_texting_age.RData'))
posterior_age <- as.matrix(fit_age)
dimnames(posterior_age)$parameters[8:11] <- c(
  "Old Drivers (Texting)", "Young Drivers (Texting)",
  "Old Drivers (Normal)", "Young Drivers (Normal)")
mcmc_areas(posterior_age, pars=c(
  "Old Drivers (Texting)", "Young Drivers (Texting)",
  "Old Drivers (Normal)", "Young Drivers (Normal)"))
```
:::
::::::::::::::
## AR(1) Multivariate Multiplicative: Dianostics
:::::::::::::: {.columns}
::: {.column}
```{r ar1_multi2_trace, fig.width=8, fig.height=6}
fit_age <- readRDS(
  file=here('etc', 'fits', 'ar1_texting_age.RData')) 
posterior_age <- as.array(fit_age)
bayesplot_theme_set(theme_minimal())
plot_title <- ggtitle("Trace plots")
color_scheme_set("blue")
mcmc_trace(posterior_age, 
           pars = c("alpha", "rho", "sigma_base"),
           regex_pars = c("log"))
  plot_title
```

:::
::: {.column}
```{r, fig.width=8, fig.height=6}
mcmc_acf(posterior_age, 
           pars = c("alpha", "rho", "sigma_base"),
           regex_pars = c("log"))
```
:::
::::::::::::::

## Conclusions

* On average, with the additive model, the presence of texting effect doubles the variance of lane positioning 

* Large variation between drivers
  - Drivers with higher lane position variance -> higher lane position variance when texting

* Older drivers exhibit increased variance for both texting and non-texting

* Multiplicative model: Significant interaction effect with age and texting

# Backup slides
## References

1. Taamneh, S. et al. A multimodal dataset for various forms of distracted driving. Sci. Data 4:170110 doi: 10.1038/sdata.2017.110 (2017).

2. Betancourt, Michael. 2018. "A Principled Bayesian Workflow" June 2018

4. Stan Development Team. "Stan Modeling Language User’s Guide and Reference Manual" Version 2.17.0, Sept 2017

3. Kim, Shephard, Chib (1998) "Stochastic Volatility: Likelihood Inference and Comparison with ARCH Models" *The Review of Economic Studies Vol. 65, No. 3*

## Future steps

- Incorporate bayesian methods for dealing with missing data

- Incorporate "change-point" model to account for lane changes

- Determine better methods for posterior predictive checking for time series data
  - Correlogram & Variogram
  
- Generative modelling (hidden markov model) instead of autoregressive modelling
  
## Computing Cluster Setup (Amazon Web Services)

### Prior Predictive Modelling

- Each prior predictive model runs 1000 simulations from the generative model

- Fitting 1000 simulations is a time consuming process on local machine

  - `Stan` runs 4 markov chains in parallel and aggregates (4 cores)
  - 1000 * 4 = 4000 CPU's to run fit observations for one model!
  
- Created a docker container with `RStan` and submitted jobs to AWS Batch service

## Prior Predictive Fit Tests
:::::::::::::: {.columns}
::: {.column}
![Shrinkage](/Users/bryanyu/Dropbox/STATS/STAT685/etc/pix/Shrinkage.png)
:::
::: {.column}
![Simulation Based Calibration](/Users/bryanyu/Dropbox/STATS/STAT685/etc/pix/sbc.png)
:::
::::::::::::::

## AR(1): Prior Predictive Analysis
:::::::::::::: {.columns}
::: {.column}
```{r generate_ensemble, results="hide", fig.width=8, fig.height=6}
fit <- readRDS(here('etc', 'fits', 'ar1_gen.RData'))
probs <- c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9)
# prior predictive time series
post <- as.matrix(fit)
sel <- grep("y_ppc", colnames(post))
ci50 <- matrix(NA, nrow = length(sel), ncol = 2)
ci90 <- matrix(NA, nrow = length(sel), ncol = 2)
for (i in 1:length(sel)) {
  ci50[i,] <- quantile(post[,sel[i]], prob = c(0.25, 0.75), names = FALSE)
  ci90[i,] <- quantile(post[,sel[i]], prob = c(0.05, 0.95), names = FALSE)
}

plot(0, type= "n", 
     xlim = c(0,max(md_half$Distance)), ylim = c(-10, 10),
     xlab = "Distance", ylab = "Lane Offset (m)",
     main = "Prior Predictive Ensemble\nLane Offset: 50% and 90% intervals")
t <- md_half$Distance
polygon(c(rev(t), t), c(rev(ci90[,1]), ci90[,2]),  col = colors$c_light, border = FALSE)
polygon(c(rev(t), t), c(rev(ci50[,1]), ci50[,2]), col = colors$c_mid, border = FALSE)
t <- md_half$Distance[which(input_data$texting==2)]
i <- which(input_data$texting==2)
polygon(c(rev(t), t), c(rev(ci90[i,1]), ci90[i,2]), col = colors$d_light, border = FALSE)
polygon(c(rev(t), t), c(rev(ci50[i,1]), ci50[i,2]), col = colors$d_mid, border = FALSE)
legend("bottomright", c("No stimulus", "Texting"),
       col = c(colors$c_mid, colors$d_mid), lwd = c(2,2,2), text.font=0.5)
```

:::
::: {.column}
![](/Users/bryanyu/Dropbox/STATS/STAT685/etc/plots/ar1_texting_sbc_shrink.png )
:::
::::::::::::::

## Stochastic Volatility: Setup
:::::::::::::: {.columns}
::: {.column}

### Conceptual Analysis
Mean of lane offset is constant but with changing volatility. The SV model has additional parameters to deal with the structure of this data. Latent variables and generative nature of model allows for additional complexity.

### Define observations
$$T: \textrm{Number of observations}$$
$$N_{texting}: \textrm{Number of texting states } (j)$$
$$y_t: \textrm{Lane Offset (meters), mean corrected}$$
$$x_t: \textrm{Texting indicator (1: ND, 2: MD)}$$
:::
::: {.column}
### Likelihood and priors
$$y_t \sim \mathcal{N}(0, \textrm{exp}(h_t / 2))$$
$$h_t \sim \mathcal{N}(\mu + \delta + \phi(h_t - \mu), \sigma)$$
$$h_1 \sim \mathcal{N}(\mu, \frac{\sigma}{\sqrt{1 - \phi^2}})$$
\newline
$$\mu \sim \mathcal{N}(0, 1): \textrm{Mean log volatility}$$
$$\phi \sim \textrm{Uniform}(-1, 1): \textrm{Persistence of volatility}$$
$$\sigma \sim \mathcal{N}(0, 1)$$
$$\delta \sim \mathcal{N}(0, 0.05): \textrm{Texting effect}$$
:::
::::::::::::::

## Stochastic Volatility: Fit Observations
:::::::::::::: {.columns}
::: {.column}
```{r sv2}
fit <- readRDS(here("etc", "results", "sv2.rds"))
pairs(fit, pars=c("mu", "sigma", "phi", "delta_texting"))
```
:::
::: {.column}
1. Lots of divergences (red dots)

2. $\phi$ parameter stuck near 1 indicating non-stationarity

3. On the default chain settings (n=2000, 4 chains), looks like there are two different modes

4. SV is not flexible enough to model this, HMM model maybe more appropriate
:::
::::::::::::::

```{r, eval=FALSE, include=FALSE}
fit_age <- readRDS(file=here('etc', 'fits', 'ar1_texting_age.RData'))
summary(fit_age,
        pars=c("rho", "alpha", "sigma_base",
               "log_delta_sigma_age", "log_delta_sigma_texting"),
        prob=c(0.05, 0.5, 0.95))$summary %>% 
  as.data.frame() %>%
  dplyr::select(mean, sd, `5%`, `50%`, `95%`) %>%
  knitr::kable(digits=3, format="latex")
```

