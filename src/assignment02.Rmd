---
title: "Distracted Driving Assignment 2"
author: Bryan Yu - bryanyu@tamu.edu
output: html_document
---

```{r setup, echo=FALSE, message=FALSE, cache=TRUE}
library(tidyverse)
library(here)
library(conflicted)

dir_path <- here("data")
subject <- dir_path %>% dir() %>% str_sub(0, 4)
file_paths <- map(dir(here("data")), function(file_name) c(here("data", file_name)))

index_data <- readxl::read_excel(here("etc", "Dataset-Table-Index.xlsx")) %>%
    dplyr::filter(stringr::str_detect(Subject, 'T[0-9]{3}'))
    
subject_bio <- index_data %>% 
    dplyr::filter(!is.na(Gender)) %>%
    select(subject=Subject, gender=Gender, age_group=`Age Group`)

subject_test <- index_data %>%
    select(subject=Subject, session=Session, FACS, eye)
drive_map <- c(1:8)
names(drive_map) <- c("BL", "PD", "RD", "ND", "CD", "ED", "MD", "FD")

phase_convert <- function(Time) {
    if (Time < 80) {
        return(1)
    } else if (Time >= 80 & Time < 80 + 160) {
        return(2)
    } else if (Time >= 80 + 160 & Time < 80 + 160 + 240) {
        return(3)
    } else if (Time >= 80 + 160 + 240 & Time < 80 + 160 + 240 + 160) {
        return(4)
    } else {
        return(5)
    }
}

df <- map(file_paths, read.csv) %>% 
    set_names(subject) %>% 
    bind_rows(.id = "Subject")
df$Drive <- names(drive_map[df$Drive])
df$phase <- map_dbl(df$Time, phase_convert)
df <- df %>% 
    dplyr::filter(Drive %in% c("ND", "MD")) %>%
    mutate(phase = as.factor(phase))
# df_nest <- df %>% group_by(Subject) %>% nest()

nd_df <- df %>%
    dplyr::filter(Drive == "ND") %>%
    dplyr::filter(!between(Distance, 5000, 7000))

rm(file_paths, dir_path, index_data, phase_convert)
```

#### 1. Summary

**Modeling**

In order to familiarize myself with `Stan` and bayesian modeling, initial implementation focused on investigating the variation of the normal driving mode without the distracted driving term from Experiment 1$^1$. Future models will incorporate the distracted driving as a separate intercept term. 

**Data set issues**

Dr. Akleman noted last week that facial expression would useful to incorporate into the model. Due to data size constraints (57.5 GB), imported data into S3 and extracted *.FACs data. Will add to model in the future during feature engineering phase.

#### 2. Observations:

```{r friendly_data, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)

ggplot(df, aes(x=Distance, y=Lane.Position)) + 
    geom_line(aes(colour=phase)) +
    facet_grid(Drive ~ .) +
    theme_bw() +
    labs(x = 'Distance', y = 'Lane Position (m)') +
    theme(legend.position = "bottom")

ggplot(nd_df, aes(x=Distance, y=Lane.Position)) + 
    geom_point(size=1) +
    theme_bw() +
    labs(x = 'Distance', y = 'Lane Position (m)') +
    theme(legend.position = "bottom")
```

```{r structured_data, include=FALSE}
#library(here)
#library(tidyverse)
#res_files <- dir(here("structured_study_data"), pattern="*.res", recursive=TRUE, full.names=TRUE)
#nd_files <- res_files[str_detect(res_files, "ND")]
#md_files <- res_files[str_detect(res_files, "MD")]

#nd_subjects <- str_sub(nd_files, 71, 74)
#md_subjects <- str_sub(md_files, 71, 74)

#nd_df <- map(nd_files, readxl::read_excel, skip=8) %>%
#    set_names(nd_subjects) %>%
#    bind_rows(.id = "subject") %>%
#    dplyr::filter(!subject %in% c("T060", "T061"))

#md_df <- map(md_files, readxl::read_excel, skip=8) %>%
#    set_names(md_subjects) %>%
#    bind_rows(.id = "subject") %>%
#    dplyr::filter(!subject %in% c("T060", "T061"))

#rm(res_files, nd_files, md_files, nd_subjects, md_subjects)

#ggplot(nd_df, aes(x=Time, y=`Lane Position`, group=subject)) +
#    geom_line() +
#    theme_bw() +
#    labs(x = 'Time', y = 'Lane Position') +
#    theme(legend.position = "none")

#ggplot(md_df, aes(x=Time, y=`Lane Position`, group=subject)) +
#    geom_line() + 
#    theme_bw() +
#    labs(x = 'Time', y = 'Lane Position') +
#    theme(legend.position="none")
```

1. Lane deviation appears stationary, no growth/decay trend appears evident. Candidate for stochastic volatility model similar to financial returns for the return of an asset in discrete time$^2$. 

2. Heavy tails in the distracted driving segment

3. Changepoints will be useful to incorporate known differences in behavior (phases of driving / lane change). However, timing does not appear to follow phases as described in Experiment 1 description.

#### 3. Data Quality

* Missing eye tracking data for the following subjects:

```{r, echo=FALSE, message=FALSE} 
library(tidyverse)
subject_test %>% 
    dplyr::filter(eye==0 & (session=='ND' | session=='MD')) %>% 
    distinct(subject)
```

* Missing FAC data for the following subjects:

```{r, echo=FALSE, message=FALSE} 
library(tidyverse)
subject_test %>% 
    dplyr::filter(FACS==0 & (session=='ND' | session=='MD')) %>% 
    distinct(subject)
```

* Data not properly labelled in the `Structured Study Data` for the following drives T018-5/6, T020-4/7 and missing T026-6:

* Data is described as randomized order for 4-7 loaded drives but in the R-Friendly Dataset, order of drives is not randomized

* Missing lane position data for T060 / T061 in the Structured Data Set

#### 4. Current model

$y = \alpha + \beta_3 x_i + \epsilon_n$ where $\epsilon$ ~ Normal(0, $\sigma$)

```{r, echo=FALSE, message=FALSE}
library("rstan") 
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
here("src", "nd_nolanechange.stan")
```


#### 5. Questions

1. What is lane offset? Not specified in the description 

**References**

1. Taamneh, S. et al. *A multimodal dataset for various forms of distracted driving.* Sci. Data 4:170110 doi: 10.1038/sdata.2017.110 (2017). 

2. Stan Development Team (2017) *Stan Modeling Language: User's Guide and Reference Manual* Version 2.17.0 (2017), 10.5
```

